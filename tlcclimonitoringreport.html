<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LI MONITORING REPORT</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        table, th, td {
            border: 1px solid #2c3e50;
        }
        th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: center;
            position: sticky;
            top: 0;
        }
        td {
            padding: 10px;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #e9f7fe;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c3e50;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        label {
            font-weight: bold;
            margin-right: 10px;
        }
        input[type="date"] {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        .button-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button#printBtn {
            background-color: #3498db;
            color: white;
        }
        button#printBtn:hover {
            background-color: #2980b9;
        }
        button#downloadBtn {
            background-color: #27ae60;
            color: white;
        }
        button#downloadBtn:hover {
            background-color: #219653;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        .loading {
            background-color: #d4edff;
            color: #004085;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        @media print {
            .no-print {
                display: none;
            }
            body {
                margin: 0;
                padding: 15px;
            }
            h1 {
                color: black;
                border-bottom: 2px solid black;
            }
        }
    </style>
</head>
<body>

    <h1>LI MONITORING REPORT</h1>

    <div class="controls no-print">
        <div>
            <label for="datePicker">Select Date:</label>
            <input type="date" id="datePicker" />
        </div>
        <div class="button-container">
            <button id="printBtn" onclick="printTable()">Print Report</button>
            <button id="downloadBtn" onclick="downloadCSV()">Download CSV</button>
        </div>
    </div>

    <div id="statusMessage"></div>

    <table id="dataTable">
        <thead>
            <!-- Dynamic headers will be inserted here -->
        </thead>
        <tbody>
            <!-- Data will be inserted here -->
        </tbody>
    </table>

    <script>
        // Replace with your Google Sheets API endpoint
        const sheetId = '1HDBieARU2yEJZGAqus4S1JfF_oECrzbwADfyNY42rCM';
        const apiKey = 'AIzaSyBG5Y_6PX9WT-0Mu5-Wv8Z9hA6ATF3TqR0';
        const sheetName = 'Sheet1'; // Change this if necessary

        // Columns we want to display (B, C, O, F, H, S, T, U, V, AN, AP, BA)
        const relevantColumns = [1, 2, 14, 5, 7, 18, 19, 20, 21, 36, 38, 48];

        // Default to current date
        let selectedDate = new Date().toISOString().split('T')[0]; // Format as yyyy-mm-dd

        // Initialize the date picker with the current date
        document.getElementById('datePicker').value = selectedDate;

        // Fetch data when the page loads or the date is changed
        document.getElementById('datePicker').addEventListener('change', (e) => {
            selectedDate = e.target.value;
            fetchData();
        });

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        async function fetchData() {
            showStatus('Loading data...', 'loading');
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const rows = data.values;

                if (!rows || rows.length < 2) {
                    showStatus('No data found in the sheet!', 'error');
                    return;
                }

                const headers = rows[0]; // First row contains the headers
                const filteredRows = rows.slice(1).filter(row => row.length > 1 && formatDate(row[1]) === selectedDate); // Column B is index 1

                // Populate the table with dynamic headers
                populateHeaders(headers);

                // Populate the table with filtered rows
                if (filteredRows.length > 0) {
                    populateTable(filteredRows);
                    showStatus(`Data loaded successfully for ${selectedDate}`, 'success');
                } else {
                    showStatus(`No data found for ${selectedDate}`, 'error');
                    clearTable();
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showStatus('Error loading data. Please check console for details.', 'error');
            }
        }

        // Function to format date from Google Sheets (yyyy-mm-dd)
        function formatDate(dateString) {
            // Assuming dateString is in 'yyyy-mm-dd' format
            return dateString ? dateString.trim() : '';
        }

        // Function to clear table
        function clearTable() {
            const tableBody = document.querySelector("#dataTable tbody");
            tableBody.innerHTML = '';
        }

        // Function to dynamically populate the table headers
        function populateHeaders(headers) {
            const tableHead = document.querySelector("#dataTable thead");
            tableHead.innerHTML = ''; // Clear previous headers
            const tr = document.createElement("tr");

            relevantColumns.forEach(colIndex => {
                const th = document.createElement("th");
                th.textContent = headers[colIndex] || `Column ${colIndex}`; // Set header text based on relevant columns
                tr.appendChild(th);
            });

            tableHead.appendChild(tr);
        }

        // Function to populate table rows
        function populateTable(rows) {
            const tableBody = document.querySelector("#dataTable tbody");
            tableBody.innerHTML = ''; // Clear previous data
            
            rows.forEach(row => {
                const tr = document.createElement("tr");
                relevantColumns.forEach(colIndex => {
                    const td = document.createElement("td");
                    td.textContent = row[colIndex] || ''; // Handle missing data
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        // Print table
        function printTable() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Software Developed By Saurabh N Kalbande - ${selectedDate}</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                margin: 20px;
                            }
                            h1 {
                                text-align: center;
                                color: #000;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 20px;
                            }
                            table, th, td {
                                border: 1px solid black;
                            }
                            th {
                                background-color: #f2f2f2;
                                padding: 8px;
                                text-align: center;
                            }
                            td {
                                padding: 8px;
                            }
                            @media print {
                                body {
                                    margin: 0;
                                    padding: 15px;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>DAILY LI MONITORING REPORT - ${selectedDate}</h1>
                        ${document.getElementById('dataTable').outerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // Wait for content to load before printing
            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }

        // Download table data as CSV
        function downloadCSV() {
            const table = document.getElementById('dataTable');
            
            // Check if table has data
            if (table.rows.length <= 1) {
                showStatus('No data to download!', 'error');
                return;
            }
            
            let csv = [];
            
            // Get headers from thead
            const headerRow = table.tHead.rows[0];
            const headerData = [];
            for (let j = 0; j < headerRow.cells.length; j++) {
                headerData.push('"' + (headerRow.cells[j].innerText || '').replace(/"/g, '""') + '"');
            }
            csv.push(headerData.join(','));
            
            // Get data from tbody
            for (let i = 0; i < table.tBodies[0].rows.length; i++) {
                const row = table.tBodies[0].rows[i];
                const rowData = [];
                for (let j = 0; j < row.cells.length; j++) {
                    // Escape quotes and wrap in quotes for CSV
                    const cellText = row.cells[j].innerText || '';
                    rowData.push('"' + cellText.replace(/"/g, '""') + '"');
                }
                csv.push(rowData.join(','));
            }

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const dateForFilename = selectedDate.replace(/-/g, '');
            
            link.setAttribute('href', url);
            link.setAttribute('download', `LI_Report_${dateForFilename}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('CSV downloaded successfully!', 'success');
        }

        // Fetch data when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
        });
    </script>
</body>
</html>