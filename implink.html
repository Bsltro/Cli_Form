
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Restriction Alert</title>
</head>
<body>
    <h1>Enter Speed Restriction Details</h1>

    <!-- Start Place and Start Kilometer Inputs -->
    <label for="startPlace">Start Place: </label>
    <input type="text" id="startPlace" placeholder="Enter Start Place" /><br><br>

    <label for="startKm">Start Kilometer: </label>
    <input type="number" id="startKm" placeholder="Enter Start Kilometer" /><br><br>

    <!-- End Place and End Kilometer Inputs -->
    <label for="endPlace">End Place: </label>
    <input type="text" id="endPlace" placeholder="Enter End Place" /><br><br>

    <label for="endKm">End Kilometer: </label>
    <input type="number" id="endKm" placeholder="Enter End Kilometer" /><br><br>

    <button onclick="addSpeedZone()">Add</button><br><br>

    <!-- Inputs for Speed Zones (will be shown after clicking Add button) -->
    <div id="speedZoneInputs" style="display:none;">
        <label for="fromKm">From Kilometer: </label>
        <input type="number" id="fromKm" placeholder="Enter From Kilometer" /><br><br>

        <label for="toKm">To Kilometer: </label>
        <input type="number" id="toKm" placeholder="Enter To Kilometer" /><br><br>

        <label for="speedLimit">Speed Limit (km/h): </label>
        <input type="number" id="speedLimit" placeholder="Enter Speed Limit" /><br><br>

        <button onclick="saveSpeedZone()">Save Speed Zone</button><br><br>
    </div>

    <h2>Speed Zones Set:</h2>
    <ul id="speedZonesList"></ul>

    <h2>Current Speed and Distance Covered:</h2>
    <p id="location">Waiting for motion data...</p>

    <script>
        let speedZones = [];
        let currentKm = 0;  // Current kilometer (initially 0)
        let currentSpeed = 0;  // Current speed in km/h
        let lastAcceleration = { x: 0, y: 0, z: 0 }; // To store previous acceleration data
        let lastUpdateTime = Date.now(); // To track time intervals
        let accelerationFactor = 0.1;  // Scale factor for acceleration to speed conversion

        // Function to handle the "Add" button click
        function addSpeedZone() {
            // Show the speed zone input fields after the "Add" button is clicked
            document.getElementById('speedZoneInputs').style.display = 'block';
        }

        // Function to save the speed zone
        function saveSpeedZone() {
            const startKm = parseFloat(document.getElementById('startKm').value);
            const fromKm = parseFloat(document.getElementById('fromKm').value);
            const toKm = parseFloat(document.getElementById('toKm').value);
            const speedLimit = parseInt(document.getElementById('speedLimit').value);

            // Validate input
            if (isNaN(fromKm) || isNaN(toKm) || isNaN(speedLimit) || toKm <= fromKm) {
                alert('Please enter valid numbers for From Kilometer, To Kilometer, and Speed Limit.');
                return;
            }

            // Save the speed zone (adjusted for the start kilometer entered by the user)
            speedZones.push({ fromKm: startKm + fromKm, toKm: startKm + toKm, speedLimit: speedLimit });

            // Update the list of speed zones shown on the page
            const speedZoneList = document.getElementById('speedZonesList');
            const listItem = document.createElement('li');
            listItem.textContent = `From Km: ${startKm + fromKm} to Km: ${startKm + toKm} - Speed Limit: ${speedLimit} km/h`;
            speedZoneList.appendChild(listItem);

            // Provide feedback to the user
            alert(`Speed zone added from km ${startKm + fromKm} to km ${startKm + toKm} with speed limit of ${speedLimit} km/h`);
            
            // Clear the fields
            document.getElementById('fromKm').value = '';
            document.getElementById('toKm').value = '';
            document.getElementById('speedLimit').value = '';
        }

        // Function to handle the device motion event
        function handleDeviceMotion(event) {
            const acceleration = event.accelerationIncludingGravity;  // Get acceleration data
            if (acceleration) {  // Check if acceleration data is available
                const x = acceleration.x;
                const y = acceleration.y;
                const z = acceleration.z;

                // Log the acceleration data to debug
                console.log("Device Motion Data:", acceleration);

                // Calculate the change in speed based on acceleration
                const deltaTime = (Date.now() - lastUpdateTime) / 1000; // Time interval in seconds
                const deltaAcceleration = Math.sqrt(Math.pow(x - lastAcceleration.x, 2) + Math.pow(y - lastAcceleration.y, 2) + Math.pow(z - lastAcceleration.z, 2));

                // Calculate speed change in km/h using acceleration data and time interval
                currentSpeed += deltaAcceleration * accelerationFactor * deltaTime * 3600;  // km/h (scaled)

                // Ensure speed is non-negative
                currentSpeed = Math.max(currentSpeed, 0);

                // Update the current kilometer based on speed (assuming small time intervals)
                const distanceTraveled = currentSpeed * deltaTime / 3600; // Convert km/h to km per second
                currentKm += distanceTraveled;

                // Update the location display
                document.getElementById('location').innerText = `Speed: ${currentSpeed.toFixed(2)} km/h, Km: ${currentKm.toFixed(2)}`;

                // Check for speed restrictions
                checkSpeedRestrictions();

                // Store the current time and acceleration for the next iteration
                lastUpdateTime = Date.now();
                lastAcceleration = { x, y, z };
            }
        }

        // Function to check if the vehicle is approaching or overspeeding in a speed-restricted zone
        function checkSpeedRestrictions() {
            speedZones.forEach(zone => {
                // Alert when within 500 meters (0.5 km) of the speed restriction
                if (Math.abs(currentKm - zone.fromKm) <= 0.5) {
                    speak(`Ahead is a speed restriction of ${zone.speedLimit} km/h`);
                }

                // Alert if overspeeding in the speed-restricted zone
                if (currentKm >= zone.fromKm && currentKm <= zone.toKm && currentSpeed > zone.speedLimit) {
                    speak(`You are overspeeding, please reduce speed!`);
                }
            });
        }

        // Function to trigger speech (voice alerts)
        function speak(message) {
            const speech = new SpeechSynthesisUtterance(message);
            speech.lang = 'en-US';  // Specify language
            speech.rate = 1;  // Normal rate of speech
            speech.pitch = 1;  // Normal pitch

            // Speak the message
            window.speechSynthesis.speak(speech);
        }

        // Function to request permissions for motion
        function requestMotionPermissions() {
            if (typeof DeviceMotionEvent.requestPermission === "function") {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            // Permissions granted, start listening to motion events
                            window.addEventListener("devicemotion", handleDeviceMotion, true);
                        } else {
                            alert("Motion permissions are required to use the accelerometer.");
                        }
                    })
                    .catch(error => {
                        console.error("Permission request failed:", error);
                    });
            } else {
                // For browsers that don't require permission prompt
                window.addEventListener("devicemotion", handleDeviceMotion, true);
            }
        }

        // Start tracking device motion
        function startTracking() {
            // Request motion permissions
            requestMotionPermissions();
        }

        // Start tracking when the page loads
        startTracking();
    </script>
</body>
</html>