<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Restriction Alert</title>
</head>
<body>
    <h1>Enter Speed Restriction Details</h1>

    <!-- Start Place and Start Kilometer Inputs -->
    <label for="startPlace">Start Place: </label>
    <input type="text" id="startPlace" placeholder="Enter Start Place" /><br><br>

    <label for="startKm">Start Kilometer: </label>
    <input type="number" id="startKm" placeholder="Enter Start Kilometer" /><br><br>

    <!-- End Place and End Kilometer Inputs -->
    <label for="endPlace">End Place: </label>
    <input type="text" id="endPlace" placeholder="Enter End Place" /><br><br>

    <label for="endKm">End Kilometer: </label>
    <input type="number" id="endKm" placeholder="Enter End Kilometer" /><br><br>

    <button onclick="addSpeedZone()">Add</button><br><br>

    <!-- Inputs for Speed Zones (will be shown after clicking Add button) -->
    <div id="speedZoneInputs" style="display:none;">
        <label for="fromKm">From Kilometer: </label>
        <input type="number" id="fromKm" placeholder="Enter From Kilometer" /><br><br>

        <label for="toKm">To Kilometer: </label>
        <input type="number" id="toKm" placeholder="Enter To Kilometer" /><br><br>

        <label for="speedLimit">Speed Limit (km/h): </label>
        <input type="number" id="speedLimit" placeholder="Enter Speed Limit" /><br><br>

        <button onclick="saveSpeedZone()">Save Speed Zone</button><br><br>
    </div>

    <h2>Speed Zones Set:</h2>
    <ul id="speedZonesList"></ul>

    <h2>Current Speed and Distance Covered:</h2>
    <p id="location">Waiting for motion data...</p>

    <script>
        let speedZones = [];
        let currentKm = 0;  // Current kilometer (initially 0)
        let currentSpeed = 0;  // Current speed in km/h
        let lastUpdateTime = Date.now(); // To track time intervals
        let lastAcceleration = { x: 0, y: 0, z: 0 }; // Store previous acceleration data
        const ACCELERATION_SENSITIVITY = 0.2; // Sensitivity threshold for acceleration to prevent noise
        const TIME_INTERVAL = 1000; // Update interval in milliseconds (1 second)

        // Function to handle the "Add" button click
        function addSpeedZone() {
            document.getElementById('speedZoneInputs').style.display = 'block';
        }

        // Function to save the speed zone
        function saveSpeedZone() {
            const startKm = parseFloat(document.getElementById('startKm').value);
            const fromKm = parseFloat(document.getElementById('fromKm').value);
            const toKm = parseFloat(document.getElementById('toKm').value);
            const speedLimit = parseInt(document.getElementById('speedLimit').value);

            if (isNaN(fromKm) || isNaN(toKm) || isNaN(speedLimit) || toKm <= fromKm) {
                alert('Please enter valid numbers for From Kilometer, To Kilometer, and Speed Limit.');
                return;
            }

            speedZones.push({ fromKm: startKm + fromKm, toKm: startKm + toKm, speedLimit: speedLimit });
            const speedZoneList = document.getElementById('speedZonesList');
            const listItem = document.createElement('li');
            listItem.textContent = `From Km: ${startKm + fromKm} to Km: ${startKm + toKm} - Speed Limit: ${speedLimit} km/h`;
            speedZoneList.appendChild(listItem);
            alert(`Speed zone added from km ${startKm + fromKm} to km ${startKm + toKm} with speed limit of ${speedLimit} km/h`);

            document.getElementById('fromKm').value = '';
            document.getElementById('toKm').value = '';
            document.getElementById('speedLimit').value = '';
        }

        // Function to handle the device motion event
        function handleDeviceMotion(event) {
            const acceleration = event.accelerationIncludingGravity;  // Get acceleration data
            if (acceleration) {
                const x = acceleration.x || 0;
                const y = acceleration.y || 0;
                const z = acceleration.z || 0;

                // Check if motion is significant
                const totalAcceleration = Math.sqrt(x * x + y * y + z * z);
                if (totalAcceleration < ACCELERATION_SENSITIVITY) {
                    return; // Ignore minor movements
                }

                // Calculate speed based on acceleration
                const deltaTime = (Date.now() - lastUpdateTime) / 1000; // Time in seconds
                const deltaSpeed = Math.sqrt(x * x + y * y + z * z); // Calculate total acceleration

                // Update speed and ensure it doesn't decrease negatively
                currentSpeed += deltaSpeed * deltaTime * 3.6; // Convert to km/h
                currentSpeed = Math.max(currentSpeed, 0);

                // Update Km based on speed
                const distanceTraveled = (currentSpeed / 3600) * deltaTime; // km
                currentKm += distanceTraveled;

                // Update the location display
                document.getElementById('location').innerText = `Speed: ${currentSpeed.toFixed(2)} km/h, Km: ${currentKm.toFixed(2)}`;

                // Check for speed restrictions
                checkSpeedRestrictions();

                // Store the current time and acceleration for the next iteration
                lastUpdateTime = Date.now();
            }
        }

        // Function to check for speed restrictions
        function checkSpeedRestrictions() {
            speedZones.forEach(zone => {
                if (Math.abs(currentKm - zone.fromKm) <= 0.5) {
                    speak(`Ahead is a speed restriction of ${zone.speedLimit} km/h`);
                }

                if (currentKm >= zone.fromKm && currentKm <= zone.toKm && currentSpeed > zone.speedLimit) {
                    speak(`You are overspeeding, please reduce speed!`);
                }
            });
        }

        // Function to trigger speech (voice alerts)
        function speak(message) {
            const speech = new SpeechSynthesisUtterance(message);
            speech.lang = 'en-US'; // Specify language
            speech.rate = 1;  // Normal rate of speech
            speech.pitch = 1;  // Normal pitch

            window.speechSynthesis.speak(speech);
        }

        // Request permissions for motion
        function requestMotionPermissions() {
            if (typeof DeviceMotionEvent.requestPermission === "function") {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener("devicemotion", handleDeviceMotion, true);
                        } else {
                            alert("Motion permissions are required to use the accelerometer.");
                        }
                    })
                    .catch(error => {
                        console.error("Permission request failed:", error);
                    });
            } else {
                window.addEventListener("devicemotion", handleDeviceMotion, true);
            }
        }

        // Start tracking device motion
        function startTracking() {
            requestMotionPermissions();
        }

        // Start tracking when the page loads
        startTracking();
    </script>
</body>
</html>